{% extends "admin/admin_header.html" %}

{% block title %}Complaints – Admin Panel{% endblock %}

{% block styles %}
<style>
  .card {
    margin-top: 20px;
    width: 500px;
    background: var(--surface);
    border-radius: 20px;
    border: 1px solid var(--border);
    box-shadow: 0px 4px 12px rgba(0,0,0,0.15);
    transition: transform 0.2s ease-in-out;
  }
  .card:hover { transform: translateY(-4px); }

  .card-header, .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 20px;
  }

  .card-main { margin: 0 20px; }

  .card-header h4, .card-header h3 { margin: 0 20px; }

  /* Priority styles */
  .High   { color: #DC2626; font-weight: bold; }
  .Medium { color: #D97706; font-weight: bold; }
  .Low    { color: #16A34A; font-weight: bold; }


  :root {
    --bg: #F8FAFC;
    --surface: #FFFFFF;
    --primary: #1D4ED8;
    --primary-2: #3B82F6;
    --text: #1E293B;
    --muted: #64748B;
    --border: #E2E8F0;
    --shadow: 0 6px 20px rgba(2, 6, 23, .08);
    --radius: 12px;

    /* Status Colors */
    --success: #16A34A;
    --warning: #FACC15;
    --danger:  #DC2626;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

   nav a {
    color: #fff;
    margin-left: 20px;
    text-decoration: none;
    font-weight: 600;
  }

  nav a:hover { text-decoration: underline; }

  .container {
    max-width: 1100px;
    margin: 24px auto;
    padding: 0 16px;
  }

  h2 {
    margin-bottom: 16px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  th {
    background: var(--primary-2);
    color: #fff;
    font-weight: 600;
  }

  tr:last-child td {
    border-bottom: none;
  }

  .status {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
  }

   /* Fix 1: Proper alignment for title and selector */
    #selector-div
    {
      display: flex;
      flex-direction: row;
      justify-content: space-between; /* Use space-between for endpoints */
      align-items: center;
      margin-bottom: 20px; /* Add some space below the header */
    }

    #selector-div h2
    {
      margin:0; /* Remove default h2 margin */
      display: flex; /* Make h2 a flex container to align spinner/text */
      align-items: center;
    }

    /* --- Loading Indicator Styles (Re-added) --- */
    #loading-indicator {
        margin-left: 10px;
        color: var(--primary-2);
        font-size: 14px;
        font-weight: normal;
        display: none; /* Hidden by default */
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner {
        border: 2px solid #f3f3f3; /* Light grey */
        border-top: 2px solid var(--primary-2); /* Blue */
        border-radius: 50%;
        width: 14px;
        height: 14px;
        animation: spin 1s linear infinite;
        margin-right: 5px;
    }
    /* ------------------------------------------- */

   .form-group {
      margin-bottom: 0; /* Remove bottom margin to align with h2 */
      text-align: left;
    }

    .no-results-message {
        text-align: center;
        padding: 40px 20px;
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        color: var(--muted);
        font-style: italic;
        margin-top: 20px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
   <main class="container">
    
      <div id="selector-div">
          <!-- FIX: Re-added the loading indicator element here -->
          <h2>All Complaints <span id="loading-indicator"><div class="spinner"></div> Loading...</span></h2> 
          <div class="form-group">
                        <label for="admin_dept">Department</label>
                        <select id="admin_dept" name="adm_dept" required>
                            <option value="all">All Departments</option>
                            <option value="Public Works Department">Public Works Department</option>
                            <option value="Sanitation Department">Sanitation Department</option>
                            <option value="Health Department">Health Department</option>
                            <option value="Water Supply Department">Water Authority Department</option>
                            <option value="Electricity Department">Electricity Department</option>
                            <option value="Parks and Recreation">Parks and Recreation Department</option>
                            <option value="Traffic Management">Traffic Management</option>
                        </select>
                    </div>
    </div>
    
    <div id="complaints_table_container">
    <table>
      <thead>
        <tr>
          <th>Complaint ID</th>
          <th>Date Filed</th>
          <th>Filed By</th>
          <th>Status</th>
          <th>Department</th>
          <th>Location</th>
          <th>Complaint</th>
          <th>View Complaint</th>
        </tr>
      </thead>
      <tbody id="complaints-table-body">
      {% for comp in querry %}
      <tr>
        <td>{{ comp[0] }}</td>
        <td>{{ comp[1] }}</td>
        <td>{{ comp[2] }}</td>
        <td>
          {% if comp[3] == 0 %}
            Pending
          {% elif comp[3] == 1 %}
            In Progress
          {% elif comp[3] == 2 %}
            Resolved
          {% else %}
            Unknown
          {% endif %}
        </td>
        <td>{{ comp[4]}}</td>
        <td> {{ comp[5] }}</td>
        <td> {{ comp[6] }}</td>
        <td><a href="{{ url_for('view_detailed_complaints', id=comp[0]) }}">View</a></td>

      </tr>
      {% else %}
        <!-- Jinja Else Block: Renders this if querry is empty -->
        <tr id="no-complaints-row">
            <td colspan="8" style="text-align: center; color: var(--muted); font-style: italic;">
                No available complaints for this department.
            </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    </div>

    <!-- This div will be used by JavaScript if the list is empty and needs to be dynamically updated -->
    <div id="no-complaints-dynamic" class="no-results-message" style="display: none;">
        No available complaints for the selected department.
    </div>

  </main>
{% endblock %}

{% block script %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
   const departmentSelector = document.getElementById('admin_dept');
    const tableContainer = document.getElementById('complaints_table_container');
    const tableBody = document.getElementById('complaints-table-body');
    const noComplaintsRow = document.getElementById('no-complaints-row');
    const noComplaintsDynamic = document.getElementById('no-complaints-dynamic');
    
    
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- Utility Function to Render Complaints ---
    function renderComplaints(complaints) {
        let html = '';
        if (complaints && complaints.length > 0) {
            complaints.forEach(comp => {
                // Determine status text based on comp[3] (status code)
                let statusText;
                if (comp[3] === 0) {
                    statusText = 'Pending';
                } else if (comp[3] === 1) {
                    statusText = 'In Progress';
                } else if (comp[3] === 2) {
                    statusText = 'Resolved';
                } else {
                    statusText = 'Unknown';
                }

                // Assuming url_for is available from Flask/Jinja context for 'view_detailed_complaints'
                // WARNING: Since the template is rendered once, this URL replacement is the safest way to generate dynamic links in pure JS
                const viewUrl = `{{ url_for('view_detailed_complaints', id=123) }}`.replace('123', comp[0]);

                html += `
                    <tr>
                        <td>${comp[0]}</td>
                        <td>${comp[1]}</td>
                        <td>${comp[2]}</td>
                        <td>${statusText}</td>
                        <td>${comp[4]}</td>
                        <td>${comp[5]}</td>
                        <td>${comp[6]}</td>
                        <td><a href="${viewUrl}">View</a></td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
            tableContainer.style.display = 'block';
            noComplaintsDynamic.style.display = 'none';

        } else {
            // No complaints found
            tableContainer.style.display = 'none';
            noComplaintsDynamic.style.display = 'block';
        }
    }


    // --- Initial Load Check (Using Jinja Check to hide table if empty) ---
    // If the server rendered the 'No Complaints' row, hide the table on load.
    if (noComplaintsRow) {
        tableContainer.style.display = 'none';
        noComplaintsDynamic.style.display = 'block';
    } else {
        noComplaintsDynamic.style.display = 'none';
    }


   // --- Setup for Dynamic Filtering (Corrected with async/await) ---
   departmentSelector.addEventListener('change', async function() {
    const selectedDept = this.value;
      
      // Check if loadingIndicator is available before setting style
     if (loadingIndicator) {
        loadingIndicator.style.display = 'flex'; // Show loading
     }
      tableBody.innerHTML = ''; // Clear table while loading
      noComplaintsDynamic.style.display = 'none'; // Hide message while loading
      try {
      
          const response = await fetch('{{ url_for("refreshed_data_admin") }}', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json'
         },
         body: JSON.stringify({'dept': selectedDept})
      });

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.status === "error") {
              console.error("Server Error:", data.message);
              // NOTE: We use a modal/custom box instead of alert()
              console.error('Error fetching data: ' + data.message);
              renderComplaints([]); // Display empty state
          } else {
              // Data received successfully, update the table
              renderComplaints(data.complaints);
          }

      } catch (error) {
          console.error('Fetch Error:', error);
          // NOTE: We use a modal/custom box instead of alert()
          console.error('An error occurred while fetching complaints.');
          renderComplaints([]); // Display empty state on network/parse error
      } finally {
          // Check if loadingIndicator is available before setting style
          if (loadingIndicator) {
               loadingIndicator.style.display = 'none'; // Hide loading indicator
           }
      }
  });
  });
</script>
{% endblock %}